<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesoft.org/schema/mule/core"
  xmlns:db="http://www.mulesoft.org/schema/mule/db"
  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
  xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
  http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
  http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">

  <!-- GET /customers - Business Logic Flow -->
  <flow name="get-customers-business-logic" doc:name="get-customers-business-logic">
    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB select par des données mockées -->
      <ee:transform doc:name="Mock Select Customers" doc:id="mock-select-customers">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/java
---
[
  {
    id: 1,
    customer_number: "CUST001",
    party_type: "Individual",
    first_name: "Jean",
    last_name: "Dupont",
    middle_name: null,
    organization_name: null,
    date_of_birth: "1980-01-15",
    tax_id: "123456789",
    status: "Active",
    customer_segment: "Premium",
    relationship_manager: "RM001",
    created_at: "2024-01-01T10:00:00Z",
    updated_at: "2024-01-01T10:00:00Z"
  },
  {
    id: 2,
    customer_number: "CUST002",
    party_type: "Organization",
    first_name: null,
    last_name: null,
    middle_name: null,
    organization_name: "Acme Corp",
    date_of_birth: null,
    tax_id: "987654321",
    status: "Active",
    customer_segment: "Corporate",
    relationship_manager: "RM002",
    created_at: "2024-01-02T10:00:00Z",
    updated_at: "2024-01-02T10:00:00Z"
  }
] default []]]></ee:set-payload>
        </ee:message>
      </ee:transform>

      <ee:transform doc:name="Transform to Customer Response">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ((customer) -> {
  id: customer.id,
  customerNumber: customer.customer_number,
  party: {
    partyType: customer.party_type,
    firstName: customer.first_name,
    lastName: customer.last_name,
    middleName: customer.middle_name,
    organizationName: customer.organization_name,
    dateOfBirth: customer.date_of_birth,
    taxId: customer.tax_id
  },
  status: customer.status,
  customerSegment: customer.customer_segment,
  relationshipManager: customer.relationship_manager,
  createdAt: customer.created_at,
  updatedAt: customer.updated_at
})]]></ee:set-payload>
        </ee:message>
      </ee:transform>
      
      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while querying the database",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:DATABASE_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
        <on-error-propagate type="VALIDATION:INVALID_VALUE,VALIDATION:NOT_NULL" enableNotifications="true" logException="true" doc:name="Validation Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "VALIDATION_ERROR",
    message: error.description default "Invalid request parameters",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:VALIDATION_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- POST /customers - Business Logic Flow -->
  <flow name="create-customer-business-logic" doc:name="create-customer-business-logic">
    <ee:transform doc:name="Transform Request to DB Format">
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/java
var party = payload.party default {}
---
{
  customer_number: payload.customerNumber default null,
  party_type: party.partyType,
  first_name: party.firstName default null,
  last_name: party.lastName default null,
  middle_name: party.middleName default null,
  organization_name: party.organizationName default null,
  date_of_birth: party.dateOfBirth default null,
  tax_id: party.taxId default null,
  status: payload.status default 'Active',
  customer_segment: payload.customerSegment default null,
  relationship_manager: payload.relationshipManager default null
}]]></ee:set-payload>
      </ee:message>
    </ee:transform>

    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB insert par des données mockées -->
      <ee:transform doc:name="Mock Insert Customer" doc:id="mock-insert-customer">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/java
var data = payload
---
[{
  id: 1,
  customer_number: data.customer_number default "CUST001",
  party_type: data.party_type,
  first_name: data.first_name,
  last_name: data.last_name,
  middle_name: data.middle_name,
  organization_name: data.organization_name,
  date_of_birth: data.date_of_birth,
  tax_id: data.tax_id,
  status: data.status,
  customer_segment: data.customer_segment,
  relationship_manager: data.relationship_manager,
  created_at: now(),
  updated_at: now()
}]]]></ee:set-payload>
        </ee:message>
      </ee:transform>

      <ee:transform doc:name="Transform Response">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/json
var customer = payload[0]
---
{
  id: customer.id,
  customerNumber: customer.customer_number,
  party: {
    partyType: customer.party_type,
    firstName: customer.first_name,
    lastName: customer.last_name,
    middleName: customer.middle_name,
    organizationName: customer.organization_name,
    dateOfBirth: customer.date_of_birth,
    taxId: customer.tax_id
  },
  status: customer.status,
  customerSegment: customer.customer_segment,
  relationshipManager: customer.relationship_manager,
  createdAt: customer.created_at,
  updatedAt: customer.updated_at
}]]></ee:set-payload>
        </ee:message>
      </ee:transform>
      
      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while creating the customer",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:DATABASE_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
        <on-error-propagate type="VALIDATION:INVALID_VALUE,VALIDATION:NOT_NULL" enableNotifications="true" logException="true" doc:name="Validation Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "VALIDATION_ERROR",
    message: error.description default "Invalid request body",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:VALIDATION_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- GET /customers/{customerId} - Business Logic Flow -->
  <flow name="get-customer-by-id-business-logic" doc:name="get-customer-by-id-business-logic">
    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB select par des données mockées -->
      <ee:transform doc:name="Mock Select Customer by ID" doc:id="mock-select-customer-by-id">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/java
var customerId = vars.customerId default 1
---
[{
  id: customerId,
  customer_number: "CUST001",
  party_type: "Individual",
  first_name: "Jean",
  last_name: "Dupont",
  middle_name: null,
  organization_name: null,
  date_of_birth: "1980-01-15",
  tax_id: "123456789",
  status: "Active",
  customer_segment: "Premium",
  relationship_manager: "RM001",
  created_at: "2024-01-01T10:00:00Z",
  updated_at: "2024-01-01T10:00:00Z"
}] default []]]></ee:set-payload>
        </ee:message>
      </ee:transform>

      <choice doc:name="Customer Found?">
        <when expression="#[sizeOf(payload) > 0]">
          <ee:transform doc:name="Transform Response">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
var customer = payload[0]
---
{
  id: customer.id,
  customerNumber: customer.customer_number,
  party: {
    partyType: customer.party_type,
    firstName: customer.first_name,
    lastName: customer.last_name,
    middleName: customer.middle_name,
    organizationName: customer.organization_name,
    dateOfBirth: customer.date_of_birth,
    taxId: customer.tax_id
  },
  status: customer.status,
  customerSegment: customer.customer_segment,
  relationshipManager: customer.relationship_manager,
  createdAt: customer.created_at,
  updatedAt: customer.updated_at
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
        </when>
        <otherwise>
          <ee:transform doc:name="Error Response">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "NOT_FOUND",
    message: "Customer not found",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="APIKIT:NOT_FOUND" description="Customer not found"/>
        </otherwise>
      </choice>
      
      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while querying the database",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:DATABASE_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- PUT /customers/{customerId} - Business Logic Flow -->
  <flow name="update-customer-business-logic" doc:name="update-customer-business-logic">
    <ee:transform doc:name="Transform Request to DB Format">
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/java
var party = payload.party default {}
---
{
  customerId: vars.customerId,
  customer_number: payload.customerNumber default null,
  party_type: party.partyType default null,
  first_name: party.firstName default null,
  last_name: party.lastName default null,
  middle_name: party.middleName default null,
  organization_name: party.organizationName default null,
  date_of_birth: party.dateOfBirth default null,
  tax_id: party.taxId default null,
  status: payload.status default null,
  customer_segment: payload.customerSegment default null,
  relationship_manager: payload.relationshipManager default null
}]]></ee:set-payload>
      </ee:message>
    </ee:transform>

    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB update par des données mockées -->
      <ee:transform doc:name="Mock Update Customer" doc:id="mock-update-customer">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/java
var data = payload
---
[{
  id: data.customerId,
  customer_number: data.customer_number default "CUST001",
  party_type: data.party_type default "Individual",
  first_name: data.first_name default "Jean",
  last_name: data.last_name default "Dupont",
  middle_name: data.middle_name,
  organization_name: data.organization_name,
  date_of_birth: data.date_of_birth default "1980-01-15",
  tax_id: data.tax_id default "123456789",
  status: data.status default "Active",
  customer_segment: data.customer_segment default "Premium",
  relationship_manager: data.relationship_manager default "RM001",
  created_at: "2024-01-01T10:00:00Z",
  updated_at: now()
}]]]></ee:set-payload>
        </ee:message>
      </ee:transform>

      <choice doc:name="Update Successful?">
        <when expression="#[sizeOf(payload) > 0]">
          <ee:transform doc:name="Transform Response">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
var customer = payload[0]
---
{
  id: customer.id,
  customerNumber: customer.customer_number,
  party: {
    partyType: customer.party_type,
    firstName: customer.first_name,
    lastName: customer.last_name,
    middleName: customer.middle_name,
    organizationName: customer.organization_name,
    dateOfBirth: customer.date_of_birth,
    taxId: customer.tax_id
  },
  status: customer.status,
  customerSegment: customer.customer_segment,
  relationshipManager: customer.relationship_manager,
  createdAt: customer.created_at,
  updatedAt: customer.updated_at
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
        </when>
        <otherwise>
          <ee:transform doc:name="Error Response">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "NOT_FOUND",
    message: "Customer not found",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="APIKIT:NOT_FOUND" description="Customer not found"/>
        </otherwise>
      </choice>
      
      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while updating the customer",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:DATABASE_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
        <on-error-propagate type="VALIDATION:INVALID_VALUE,VALIDATION:NOT_NULL" enableNotifications="true" logException="true" doc:name="Validation Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "VALIDATION_ERROR",
    message: error.description default "Invalid request body",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:VALIDATION_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

  <!-- POST /customers/search - Business Logic Flow -->
  <flow name="search-customers-business-logic" doc:name="search-customers-business-logic">
    <ee:transform doc:name="Build Search Query Parameters">
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/java
var criteria = payload.criteria default {}
---
{
  lastName: criteria.lastName default null,
  firstName: criteria.firstName default null,
  taxId: criteria.taxId default null,
  email: criteria.email default null,
  phone: criteria.phone default null
}]]></ee:set-payload>
      </ee:message>
    </ee:transform>

    <try doc:name="Try">
      <!-- MOCK: Remplacement de l'appel DB select par des données mockées -->
      <ee:transform doc:name="Mock Search Customers" doc:id="mock-search-customers">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/java
---
[
  {
    id: 1,
    customer_number: "CUST001",
    party_type: "Individual",
    first_name: "Jean",
    last_name: "Dupont",
    middle_name: null,
    organization_name: null,
    date_of_birth: "1980-01-15",
    tax_id: "123456789",
    status: "Active",
    customer_segment: "Premium",
    relationship_manager: "RM001",
    created_at: "2024-01-01T10:00:00Z",
    updated_at: "2024-01-01T10:00:00Z"
  }
] default []]]></ee:set-payload>
        </ee:message>
      </ee:transform>

      <ee:transform doc:name="Transform Response">
        <ee:message>
          <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ((customer) -> {
  id: customer.id,
  customerNumber: customer.customer_number,
  party: {
    partyType: customer.party_type,
    firstName: customer.first_name,
    lastName: customer.last_name,
    middleName: customer.middle_name,
    organizationName: customer.organization_name,
    dateOfBirth: customer.date_of_birth,
    taxId: customer.tax_id
  },
  status: customer.status,
  customerSegment: customer.customer_segment,
  relationshipManager: customer.relationship_manager,
  createdAt: customer.created_at,
  updatedAt: customer.updated_at
})]]></ee:set-payload>
        </ee:message>
      </ee:transform>
      
      <error-handler>
        <on-error-propagate type="DB:QUERY_EXECUTION,DB:CONNECTIVITY" enableNotifications="true" logException="true" doc:name="Database Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "DATABASE_ERROR",
    message: "An error occurred while searching customers",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:DATABASE_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
        <on-error-propagate type="VALIDATION:INVALID_VALUE,VALIDATION:NOT_NULL" enableNotifications="true" logException="true" doc:name="Validation Error">
          <ee:transform doc:name="Transform Error">
            <ee:message>
              <ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  error: {
    code: "VALIDATION_ERROR",
    message: error.description default "Invalid search criteria",
    timestamp: now()
  }
}]]></ee:set-payload>
            </ee:message>
          </ee:transform>
          <raise-error type="CUSTOM:VALIDATION_ERROR" description="#[payload.error.message]"/>
        </on-error-propagate>
      </error-handler>
    </try>
  </flow>

</mule>
